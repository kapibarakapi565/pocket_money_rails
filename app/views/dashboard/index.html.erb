<div class="container">
  <div class="header">
    <h1>💰 家計管理アプリ</h1>
    
    <!-- ユーザー切り替えタブ -->
    <div class="user-tabs">
      <%= link_to dashboard_path(year: @current_year, month: @current_month, user_type: 'household'), 
          class: "user-tab #{'active' if params[:user_type] == 'household'}" do %>
        🏠 家計管理
      <% end %>
      <%= link_to dashboard_path(year: @current_year, month: @current_month), 
          class: "user-tab #{'active' unless params[:user_type].in?(['wife', 'household'])}" do %>
        👨 まさふみ
      <% end %>
      <%= link_to dashboard_path(year: @current_year, month: @current_month, user_type: 'wife'), 
          class: "user-tab #{'active' if params[:user_type] == 'wife'}" do %>
        👩 このめ
      <% end %>
    </div>
    
    <div class="month-navigation">
      <%= link_to dashboard_path(year: @prev_month.year, month: @prev_month.month, user_type: params[:user_type]), class: "nav-btn prev" do %>
        <span class="nav-icon">‹</span>
        <span class="nav-text"><%= @prev_month.strftime("%m月") %></span>
      <% end %>
      
      <div class="current-month">
        <h2><%= @month_name %></h2>
      </div>
      
      <%= link_to dashboard_path(year: @next_month.year, month: @next_month.month, user_type: params[:user_type]), class: "nav-btn next" do %>
        <span class="nav-text"><%= @next_month.strftime("%m月") %></span>
        <span class="nav-icon">›</span>
      <% end %>
    </div>
  </div>

  <div class="content">
    <!-- 🔴 Level 1: 最重要情報 -->
    <div class="priority-section level-1">
      <div class="main-info">
        <div class="remaining-budget">
          <h2>今月あといくら使える？</h2>
          <div class="mega-amount">¥<%= number_with_delimiter((@remaining_budget || 0).to_i) %></div>
          <div class="days-info">
            今日：<%= Date.current.strftime("%-m月%-d日") %> 
            <span class="days-left">（月末まで<%= @days_left %>日）</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 🟡 Level 2: 重要情報 -->
    <div class="priority-section level-2">
      <div class="status-cards">
        <div class="status-card spent">
          <h3>使用額</h3>
          <div class="amount">¥<%= number_with_delimiter((@total_spent || 0).to_i) %></div>
          <div class="percentage"><%= @usage_percentage %>%</div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: <%= [@usage_percentage, 100].min %>%"></div>
          </div>
        </div>
        <div class="status-card remaining">
          <h3>使用可能額</h3>
          <div class="amount">¥<%= number_with_delimiter((@remaining_budget || 0).to_i) %></div>
          <div class="percentage"><%= 100 - @usage_percentage %>%</div>
        </div>
      </div>
    </div>

    <!-- 🟢 Level 3: 詳細情報 -->
    <div class="priority-section level-3">
      <div class="detail-info">
        <div class="detail-item">
          <span class="label">総予算</span>
          <span class="value">¥<%= number_with_delimiter((@total_budget || 0).to_i) %></span>
        </div>
        <div class="detail-item">
          <span class="label">割当済み</span>
          <span class="value">¥<%= number_with_delimiter((@allocated_budget || 0).to_i) %></span>
        </div>
        <div class="detail-item">
          <span class="label">未割当</span>
          <span class="value">¥<%= number_with_delimiter((@unallocated || 0).to_i) %></span>
        </div>
      </div>
    </div>

    <!-- 総予算設定 -->
    <div class="section">
      <h2>💰 総予算設定</h2>
      <% if @total_budget_obj %>
        <%= form_with model: @total_budget_obj, url: total_budget_path(@total_budget_obj), method: :patch do |form| %>
          <div class="input-group">
            <%= form.number_field :amount, value: @total_budget_obj.amount.to_i, placeholder: "総予算", required: true %>
            <%= form.hidden_field :budget_type, value: (@view_type == 'household' ? 'household' : 'personal') %>
            <%= hidden_field_tag :year, @current_year %>
            <%= hidden_field_tag :month, @current_month %>
            <%= hidden_field_tag :user_type, params[:user_type] %>
            <%= form.submit "総予算更新", class: "btn" %>
          </div>
        <% end %>
      <% else %>
        <%= form_with model: TotalBudget.new, url: total_budgets_path, method: :post do |form| %>
          <div class="input-group">
            <%= form.number_field :amount, placeholder: "総予算", required: true %>
            <%= form.hidden_field :budget_type, value: (@view_type == 'household' ? 'household' : 'personal') %>
            <%= hidden_field_tag :year, @current_year %>
            <%= hidden_field_tag :month, @current_month %>
            <%= hidden_field_tag :user_type, params[:user_type] %>
            <%= form.submit "総予算設定", class: "btn" %>
          </div>
        <% end %>
      <% end %>
    </div>

    <!-- カテゴリ別予算設定 -->
    <div class="section">
      <div class="section-header">
        <h2>📊 カテゴリ別予算設定</h2>
        <% if @budgets.present? %>
          <% next_month_date = Date.new(@current_year, @current_month, 1) + 1.month %>
          <%= button_to "#{next_month_date.strftime('%Y年%-m月')}にコピー", 
              copy_to_next_month_budgets_path, 
              method: :post,
              params: { 
                year: @current_year, 
                month: @current_month, 
                user_type: params[:user_type] 
              },
              confirm: "現在の予算設定を#{next_month_date.strftime('%Y年%-m月')}にコピーしますか？",
              class: "copy-btn" %>
        <% end %>
      </div>
      <% if @total_budget > 0 %>
        <%= form_with model: Budget.new, url: budgets_path, method: :post do |form| %>
          <div class="input-group">
            <%= form.text_field :name, placeholder: "カテゴリ名", required: true %>
            <%= form.number_field :amount, placeholder: "金額", required: true, max: @unallocated %>
            <%= form.hidden_field :budget_type, value: (@view_type == 'household' ? 'household' : 'personal') %>
            <%= hidden_field_tag :year, @current_year %>
            <%= hidden_field_tag :month, @current_month %>
            <%= hidden_field_tag :user_type, params[:user_type] %>
            <%= form.submit "カテゴリ予算追加", class: "btn" %>
          </div>
          <% if @unallocated > 0 %>
            <small class="budget-info">残り予算: ¥<%= number_with_delimiter(@unallocated.to_i) %></small>
          <% else %>
            <small class="budget-warning">予算が全て割り当て済みです</small>
          <% end %>
        <% end %>
      <% else %>
        <p class="no-data">まず総予算を設定してください</p>
      <% end %>
      
      <% if @budgets.present? %>
        <div class="expense-list" 
             data-controller="sortable budget-selector" 
             data-sortable-url-value="<%= budgets_path %>"
             data-sortable-user-type-value="<%= params[:user_type] || '' %>">
          <% @budgets.each do |budget| %>
            <div class="budget-item" 
                 data-budget-id="<%= budget.id %>"
                 data-budget-selector-target="item"
                 data-action="click->budget-selector#selectItem">
              <div class="budget-main">
                <div class="budget-info">
                  <div class="budget-name"><%= budget.name %></div>
                  <div class="budget-details">
                    予算: ¥<%= number_with_delimiter(budget.amount.to_i) %> | 
                    使用: ¥<%= number_with_delimiter(budget.spent_amount.to_i) %> | 
                    残り: ¥<%= number_with_delimiter(budget.remaining_amount.to_i) %>
                    (<%= budget.usage_percentage %>%)
                  </div>
                </div>
                <div class="budget-amount">¥<%= number_with_delimiter(budget.amount.to_i) %></div>
              </div>
              <div class="budget-actions" data-budget-selector-target="actions" style="display: none;">
                <%= link_to edit_budget_path(budget, user_type: params[:user_type]), 
                    class: "action-btn edit-btn", 
                    title: "編集" do %>
                  ✏️ 編集
                <% end %>
                <%= button_to budget_path(budget), 
                    method: :delete, 
                    confirm: "本当に削除しますか？", 
                    class: "action-btn delete-btn",
                    params: { user_type: params[:user_type] },
                    title: "削除",
                    local: false do %>
                  🗑️ 削除
                <% end %>
                <button type="button" 
                        class="action-btn cancel-btn"
                        data-action="click->budget-selector#cancelSelection"
                        title="キャンセル">
                  ❌ キャンセル
                </button>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="no-data">まだカテゴリ予算が設定されていません</div>
      <% end %>
    </div>

    <!-- 支出入力 -->
    <div class="section">
      <h2>💸 支出入力</h2>
      <%= form_with model: Expense.new, url: expenses_path, method: :post do |form| %>
        <div class="input-group">
          <%= form.text_field :description, placeholder: "支出内容", required: true %>
          <%= form.number_field :amount, placeholder: "金額", required: true %>
          <%= form.date_field :expense_date, value: Date.current, required: true %>
          <% if @budgets.present? %>
            <%= form.select :budget_id, options_from_collection_for_select(@budgets, :id, :name), 
                { prompt: "予算を選択" }, { required: true } %>
          <% end %>
          <%= hidden_field_tag :year, @current_year %>
          <%= hidden_field_tag :month, @current_month %>
          <%= form.submit "支出追加", class: "btn" %>
        </div>
      <% end %>
      
      <% if @expenses.present? %>
        <div class="expense-list">
          <% @expenses.order(created_at: :desc).limit(10).each do |expense| %>
            <div class="expense-item">
              <div class="expense-info">
                <div class="expense-description"><%= expense.description %></div>
                <div class="expense-date">
                  <%= expense.expense_date.strftime("%m/%d") %> | 
                  <span class="expense-category"><%= expense.budget.name %></span>
                  <span class="budget-remaining">残り¥<%= number_with_delimiter(expense.budget.remaining_amount.to_i) %></span>
                </div>
              </div>
              <div class="expense-amount">¥<%= number_with_delimiter(expense.amount.to_i) %></div>
              <%= button_to "削除", expense_path(expense), 
                  method: :delete, 
                  confirm: "本当に削除しますか？", 
                  class: "delete-btn",
                  params: { user_type: params[:user_type] },
                  local: false %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="no-data">まだ支出が記録されていません</div>
      <% end %>
    </div>

  </div>
</div>
